// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  employeeId    String    @unique   // Employee ID for privacy (used by AI)
  passwordHash  String
  role          String    // 'admin' | 'supervisor' | 'user'
  status        String    @default("approved") // 'pending' | 'approved' | 'disabled'
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  logs          OperationLog[]
  comments      Comment[]
}

model Product {
  id            String    @id @default(uuid())
  slug          String    @unique // e.g. 'stator-line'
  name          String
  config        String    // JSON: { detailColumns, steps, stepDurations, monthlyTarget, excelPath }
  watchFolder   String?   // Optional: folder path to watch for auto-import
  isActive      Boolean   @default(false) // Track the currently active product
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  orders        Order[]
}

model Order {
  id            String    @id @default(uuid())
  woId          String    // Work Order ID from Excel
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  data          String    // JSON: Dynamic field values
  status        String    @default("N/A") // Promoted field for indexing
  priority      String    @default("Normal") // Promoted field for indexing
  commentStats  String?   // JSON: Cached statistics
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  logs          OperationLog[]
  comments      Comment[]

  @@unique([productId, woId])
  @@index([productId])
  @@index([status])
  @@index([priority])
}

model OperationLog {
  id            String    @id @default(uuid())
  timestamp     DateTime  @default(now())
  action        String    // 'Start', 'Done', 'Block', 'Reset', 'Update'
  details       String    // JSON: { step, previousValue, newValue } ex.
  
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  
  orderId       String?
  order         Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Denormalized fields for easier history viewing if user/order is deleted
  snapshot      String?   // JSON snapshot of relevant info
  
  @@index([timestamp])
  @@index([action])
  @@index([orderId])
  @@index([userId])
}

model Comment {
  id              String    @id @default(uuid())
  content         String
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  stepName        String    // The specific step this comment belongs to
  category        String    @default("GENERAL") // MATERIAL_SHORTAGE | EQUIPMENT_FAILURE | QUALITY_ISSUE | GENERAL
  structuredData  String?   // JSON: Category-specific structured data
  note            String?   // Optional free-text supplement
  triggeredStatus String?   // HOLD | QN | null
  replyToId       String?   // Reply threading
  replyTo         Comment?  @relation("CommentReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies         Comment[] @relation("CommentReplies")
  mentionedUserIds String?  // JSON: ["userId1", "userId2"]
  readBy          String?   // JSON: ["userId1", "userId2"]
  createdAt       DateTime  @default(now())
  
  @@index([orderId, stepName])
  @@index([userId, createdAt])
}
